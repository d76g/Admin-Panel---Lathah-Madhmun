# VPS Deployment Guide for Laravel Admin Panel

This guide will help you deploy the Laravel Admin Panel to a VPS server.

## Prerequisites

- VPS with Ubuntu 20.04/22.04 or similar Linux distribution
- Root or sudo access
- Domain name (optional but recommended)
- SSH access to your VPS

## Step 1: Server Setup

### 1.1 Update System Packages

```bash
sudo apt update && sudo apt upgrade -y
```

### 1.2 Install Required Software

```bash
# Install PHP 8.1+ and required extensions
sudo apt install -y software-properties-common
sudo add-apt-repository ppa:ondrej/php -y
sudo apt update
sudo apt install -y php8.1 php8.1-fpm php8.1-cli php8.1-common php8.1-mysql \
    php8.1-zip php8.1-gd php8.1-mbstring php8.1-curl php8.1-xml php8.1-bcmath \
    php8.1-intl php8.1-readline

# Install MySQL/MariaDB
sudo apt install -y mysql-server

# Install Nginx
sudo apt install -y nginx

# Install Composer
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer
sudo chmod +x /usr/local/bin/composer

# Install Node.js and npm
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# Install Git
sudo apt install -y git
```

### 1.3 Configure MySQL

```bash
sudo mysql_secure_installation

# Create database and user
sudo mysql -u root -p
```

In MySQL prompt:
```sql
CREATE DATABASE lazatmadmoon_admin CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'admin_user'@'localhost' IDENTIFIED BY 'your_strong_password_here';
GRANT ALL PRIVILEGES ON lazatmadmoon_admin.* TO 'admin_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

## Step 2: Upload Your Application

### Option A: Using Git (Recommended)

```bash
# Create application directory
sudo mkdir -p /var/www/admin-panel
sudo chown -R $USER:$USER /var/www/admin-panel

# Clone your repository (if using Git)
cd /var/www/admin-panel
git clone <your-repository-url> .

# Or upload via SCP/SFTP from your local machine:
# scp -r /path/to/local/admin-panel/* user@your-vps-ip:/var/www/admin-panel/
```

### Option B: Using SCP/SFTP

From your local machine:
```bash
# Compress the project (excluding node_modules, vendor, etc.)
cd "/Users/d75g/Documents/Programming/Gromart_V5.4_Source_Code/Website - Admin Panel - Store Panel - Landing Panel"
tar --exclude='node_modules' --exclude='vendor' --exclude='.git' \
    -czf admin-panel.tar.gz "Admin Panel/"

# Upload to VPS
scp admin-panel.tar.gz user@your-vps-ip:/tmp/

# On VPS, extract
ssh user@your-vps-ip
sudo mkdir -p /var/www/admin-panel
sudo tar -xzf /tmp/admin-panel.tar.gz -C /var/www/admin-panel --strip-components=1
```

## Step 3: Install Dependencies

```bash
cd /var/www/admin-panel

# Install PHP dependencies
composer install --optimize-autoloader --no-dev

# Install Node dependencies
npm install

# Build assets for production
npm run production
```

## Step 4: Configure Environment

```bash
# Copy environment file
cp .env.example .env

# Generate application key
php artisan key:generate

# Edit environment file
nano .env
```

Update these important settings in `.env`:

```env
APP_NAME="Admin Panel"
APP_ENV=production
APP_KEY=base64:... (generated by key:generate)
APP_DEBUG=false
APP_URL=https://yourdomain.com

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=lazatmadmoon_admin
DB_USERNAME=admin_user
DB_PASSWORD=your_strong_password_here

# Add your Firebase credentials
FIREBASE_APIKEY="your-firebase-api-key"
FIREBASE_AUTH_DOMAIN="your-project.firebaseapp.com"
FIREBASE_DATABASE_URL="https://your-project-default-rtdb.firebaseio.com"
FIREBASE_PROJECT_ID="your-project-id"
FIREBASE_STORAGE_BUCKET="your-project.appspot.com"
FIREBASE_MESSAAGING_SENDER_ID="your-sender-id"
FIREBASE_APP_ID="your-app-id"
FIREBASE_MEASUREMENT_ID="your-measurement-id"

# Mail configuration (use your SMTP settings)
MAIL_MAILER=smtp
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=your-app-password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@yourdomain.com
MAIL_FROM_NAME="${APP_NAME}"
```

## Step 5: Set File Permissions

```bash
cd /var/www/admin-panel

# Set ownership
sudo chown -R www-data:www-data /var/www/admin-panel

# Set directory permissions
sudo find /var/www/admin-panel -type d -exec chmod 755 {} \;

# Set file permissions
sudo find /var/www/admin-panel -type f -exec chmod 644 {} \;

# Set special permissions for storage and cache
sudo chmod -R 775 storage bootstrap/cache
sudo chown -R www-data:www-data storage bootstrap/cache
```

## Step 6: Run Database Migrations

```bash
cd /var/www/admin-panel

# Run migrations
php artisan migrate --force

# (Optional) Seed database
php artisan db:seed --force

# Clear and cache configuration
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

## Step 7: Configure Nginx

Create Nginx configuration file:

```bash
sudo nano /etc/nginx/sites-available/admin-panel
```

Add this configuration:

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name yourdomain.com www.yourdomain.com;
    root /var/www/admin-panel/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

Enable the site:

```bash
# Create symbolic link
sudo ln -s /etc/nginx/sites-available/admin-panel /etc/nginx/sites-enabled/

# Test Nginx configuration
sudo nginx -t

# Restart Nginx
sudo systemctl restart nginx
```

## Step 8: Setup SSL with Let's Encrypt (Recommended)

```bash
# Install Certbot
sudo apt install -y certbot python3-certbot-nginx

# Obtain SSL certificate
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# Certbot will automatically configure Nginx and set up auto-renewal
```

## Step 9: Configure Firewall

```bash
# Allow SSH, HTTP, and HTTPS
sudo ufw allow OpenSSH
sudo ufw allow 'Nginx Full'
sudo ufw enable
sudo ufw status
```

## Step 10: Setup Queue Worker (if using queues)

Create Supervisor configuration:

```bash
sudo nano /etc/supervisor/conf.d/admin-panel-worker.conf
```

Add:

```ini
[program:admin-panel-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/admin-panel/artisan queue:work --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/www/admin-panel/storage/logs/worker.log
stopwaitsecs=3600
```

Enable and start:

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start admin-panel-worker:*
```

## Step 11: Setup Cron Jobs

```bash
# Edit crontab
sudo crontab -e -u www-data
```

Add this line:

```
* * * * * cd /var/www/admin-panel && php artisan schedule:run >> /dev/null 2>&1
```

## Step 12: Performance Optimization

```bash
cd /var/www/admin-panel

# Optimize autoloader
composer install --optimize-autoloader --no-dev

# Cache configuration
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Optimize OPcache (edit php.ini)
sudo nano /etc/php/8.1/fpm/php.ini
```

Enable and configure OPcache:

```ini
opcache.enable=1
opcache.memory_consumption=128
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=10000
opcache.revalidate_freq=2
opcache.fast_shutdown=1
```

Restart PHP-FPM:

```bash
sudo systemctl restart php8.1-fpm
```

## Step 13: Security Checklist

1. **Set proper file permissions** (already done in Step 5)
2. **Hide sensitive files** - Ensure `.env` is not publicly accessible
3. **Use strong database passwords**
4. **Enable firewall** (already done in Step 9)
5. **Keep software updated**:
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```
6. **Regular backups**:
   ```bash
   # Database backup script
   mysqldump -u admin_user -p lazatmadmoon_admin > /backup/db_$(date +%Y%m%d).sql
   
   # Files backup
   tar -czf /backup/files_$(date +%Y%m%d).tar.gz /var/www/admin-panel
   ```

## Step 14: Monitoring and Maintenance

### Check Application Logs

```bash
# Laravel logs
tail -f /var/www/admin-panel/storage/logs/laravel.log

# Nginx logs
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/access.log

# PHP-FPM logs
sudo tail -f /var/log/php8.1-fpm.log
```

### Health Check Commands

```bash
# Check Nginx status
sudo systemctl status nginx

# Check PHP-FPM status
sudo systemctl status php8.1-fpm

# Check MySQL status
sudo systemctl status mysql

# Check disk space
df -h

# Check memory usage
free -h
```

## Troubleshooting

### 500 Internal Server Error

1. Check file permissions
2. Check Laravel logs: `tail -f storage/logs/laravel.log`
3. Check Nginx error logs: `sudo tail -f /var/log/nginx/error.log`
4. Ensure `.env` file exists and is configured correctly

### Permission Denied Errors

```bash
sudo chown -R www-data:www-data /var/www/admin-panel
sudo chmod -R 755 /var/www/admin-panel
sudo chmod -R 775 storage bootstrap/cache
```

### Database Connection Errors

1. Verify MySQL is running: `sudo systemctl status mysql`
2. Check database credentials in `.env`
3. Test connection: `mysql -u admin_user -p lazatmadmoon_admin`

### Assets Not Loading

1. Run `npm run production` to build assets
2. Check file permissions on `public` directory
3. Verify Nginx is serving static files correctly

## Quick Reference Commands

```bash
# Clear all caches
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear

# Rebuild caches
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Restart services
sudo systemctl restart nginx
sudo systemctl restart php8.1-fpm
sudo systemctl restart mysql

# Check application
php artisan about
```

## Post-Deployment Checklist

- [ ] Application loads without errors
- [ ] Database connection works
- [ ] Assets (CSS/JS) load correctly
- [ ] Firebase integration works
- [ ] SSL certificate is active
- [ ] File uploads work (check storage permissions)
- [ ] Email sending works (test with a test email)
- [ ] Queue workers are running (if applicable)
- [ ] Cron jobs are set up
- [ ] Backups are configured
- [ ] Monitoring is in place

## Support

For issues specific to this application, check:
- Laravel logs: `/var/www/admin-panel/storage/logs/laravel.log`
- Application documentation
- Laravel documentation: https://laravel.com/docs

